<html>

<head>
    <title>Codechef Gallery</title>
    {% load static %}
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script defer src="{% static 'js/index.js' %}"></script>
    <script>
        var picIds = [];
    </script>
    <style>
        body {
            background-color: #f5f5f5;
            color: #757575;
            text-align: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif
        }

        .front-logo {
            width: 100%;
            margin-top: 2%;
            margin-bottom: 3%;
            display: grid;
            grid-template-columns: 10% 80% 10%;
        }

        .front-logo-text {
            font-size: 25px
        }

        .profile-container {
            width: 100%;
            display: grid;
            grid-template-columns: 30% 20% 30% 20%;
            border: 1px solid #bdbdbd;
            padding: 10px;
        }

        .user-details {
            width: 90%;
            margin-left: 5%;
            display: grid;
            grid-template-rows: 10% 10% 80%;
            text-align: left;
        }

        .upload-container {
            display: grid;
            grid-template-rows: 20% 30% 30% 20%;
            background-color: #eeeeee;
            width: 80%;
            margin-left: 10%;
            margin-right: 10%;
            box-shadow: 0px 0px 2px 2px #bdbdbd;
        }

        .upload-info {
            display: grid;
            grid-template-rows: auto auto auto;
            border: 1px solid #757575;
        }

        .upload-text {
            font-size: 17px;
        }

        .upload-icon {
            font-size: 31px;
        }

        .upload-icon:hover {
            color: #2196f3;
            cursor: pointer;
        }
        .update-album{
            width:80%;
            margin-left:10%;
            margin-right:10%;
            border:1px solid #757575;
            box-shadow: 0px 0px 2px 2px #bdbdbd;
        }

        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            /* Could be more or less, depending on screen size */
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .txt-inp {
            background: transparent;
            border: none;
            outline: none;
            border-bottom: 1px solid #757575;
            padding: 5px;
            width: 80%;
            margin-left: 10%;
            margin-right: 10%;
            margin-top: 2%;
            margin-bottom: 2%;
            color: #757575;
            font-size: 17px;
        }

        .select {
            background-color: #f5f5f5;
            border: none;
            outline: none;
            padding: 5px;
            width: 80%;
            margin-left: 10%;
            margin-right: 10%;
            margin-top: 2%;
            margin-bottom: 2%;
            color: #757575;
            font-size: 17px;
            border: 1px solid #bdbdbd;
        }

        .btn {
            padding: 7px;
            width: 50%;
            margin-left: 25%;
            margin-right: 25%;
            margin-top: 2%;
            outline: none;
            border: none;
            font-size: 17px;
            cursor: pointer;
        }

        .green-btn {
            background-color: #4caf50;
            color: white;
        }

        .img-container {
            display: grid;
            grid-template-columns: 10% 10% 10% 10% 10% 10% 10% 10% 10% 10%;
            width: 90%;
            margin-left: 5%;
        }

        .image-card {
            width: 90%;
            margin-left: 5%;
            border: 1px solid #757575;
            margin-top: 5%;
            box-shadow: 2px 2px 4px 1px #bdbdbd;
            display: grid;
            grid-template-rows: 80% 20%;
        }

        .ellipsis {
            text-overflow: ellipsis;
        }
        .overflow {
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
        }
        .create-album {
            width: 90%;
            margin-left: 5%;
            border: 1px solid #757575;
            margin-top: 1%;
            box-shadow: 2px 2px 4px 1px #bdbdbd;
            cursor: pointer;
        }
        .album-form {
            width: 90%;
            margin-left: 5%;
            border: 1px solid #757575;
            margin-top: 1%;
            box-shadow: 2px 2px 4px 1px #bdbdbd;
        }
        .container {
            width: 90%;
            margin-left: 5%;
            margin-right: 5%;
            box-shadow: 0px 0px 2px 2px #bdbdbd;
            padding-bottom: 1%;
        }

        .image {
            width: 100%;
            height: 350px;
        }

        .details {
            width: 90%;
            margin-left: 5%;
            margin-right: 5%;
            margin-top: 2%;
        }

        .desc {
            width: 100%;
            border-bottom: 1px solid #bdbdbd;
            padding-bottom: 1%;
            margin-bottom: 1%;
        }

        .table {
            width: 100%;
            text-align: center;
        }
        .liked {
            color: #e91e63;
        }
    </style>
</head>

<body onload='init()'>
    <div class="front-logo">
        <div onclick="window.history.go(-1);" style="cursor: pointer;"><i style="font-size:25px;"
                class="material-icons">arrow_back</i></div>
        <div class="front-logo-text">ALBUM: {{data.name}}</div>
        <div></div>
    </div>
    <div class="container">
        <div class="image">
            <img src="{{data.url}}" style="height:90%;margin-top:1%;">
        </div>
        <div class="details">
            <div class="desc">{{data.desc}}</div>
            <table class="table">
                <tr>
                    <td>
                        <div id = "div_{{albumId}}" onclick = "toggleLike(this,'{{albumId}}')"><i class="material-icons">favorite</i> <sup><div id = "{{albumId}}">{{data.likes}}</div></sup></div>
                    </td>
                    <script>
                        picIds.push('{{albumId}}');
                    </script>
                    <td>
                        <div><i class="material-icons">public</i> <sup>{{data.access}}</sup></div>
                    </td>
                    <td>
                        <div><i class="material-icons">location_on</i> <sup>{{data.location}}</sup></div>
                    </td>
                    <td>
                        <div><i class="material-icons">date_range</i> <sup>{{data.datetime}}</sup></div>
                    </td>
                    <td>
                        <div style="color:#F44336;" onclick = "deleteAlbum('{{data.albumId}}')"><i class="material-icons">delete</i> <sup>delete</sup></div>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div onclick="showAlbumForm()" class="create-album">
            Edit Album <br /> <i style="font-size:27px;" class="material-icons">edit</i>
    </div>
    <div id="album-form" class="album-form" style="display:none;">
            <div><input id="name-cover" class="txt-inp" type="text" name="name" placeholder="Name"></div>
            <div><textarea class="txt-inp" id="desc-cover" type="text" placeholder="Description"></textarea></div>
            <div>
                <select class="select" id="access-cover" required>
                    <option value="">--Access--</option>
                    <option value="public">Public</option>
                    <option value="private">Private</option>
                </select>
            </div>
            <div id="choose-button">
                <button class="btn" style="color:#616161;box-shadow: 1px 1px 1px 1px #bdbdbd;border:1px solid#757575;">Cover
                    Photo<br /><i class="material-icons">cloud_upload</i></button>
            </div>
            <div style="display: grid;grid-template-columns: 50% 50%;margin-bottom:2%;margin-top:1%;">
                <div><button onclick="updateCover()" class="btn green-btn">UPDATE</button></div>
                <div><button onclick="hideAlbumForm()" class="btn red-btn">CANCEL</button></div>
            </div>
    </div>
    <input type="file" accept="image/jpeg,image/png" style="display:none" id="upload-cover" />
    <br />
    <div id="image-container" class="img-container">
    </div>
</body>

</html>
<script>
    var user;
    function getCookie() {
        var cookies = document.cookie.split(";");
        if (cookies.length > 1) {
            return JSON.parse(cookies[1]);
        }
        return "";
    }
    function init() {
        user = getCookie();
        if(!user)
            home();
        getMyPhotos();
        for(i=0;i<picIds.length;++i){
            hasLiked(picIds[i]);
        }
    }
    // ==== Uploading Album ========

    document.querySelector('#choose-button').addEventListener('click', function () {
        document.querySelector('#upload-cover').click();
    });
    document.querySelector('#upload-cover').addEventListener('change', function () {
        var file = this.files[0];
        var mime_types = ['image/jpeg', 'image/png'];

        if (mime_types.indexOf(file.type) == -1) {
            alert('Error : Incorrect file type');
            return;
        }

        // Max 2 Mb allowed
        if (file.size > 2 * 1024 * 1024) {
            alert('Error : Exceeded size 2MB');
            return;
        }

        alert('You have chosen the file ' + file.name);
    });
    function updateCover() {
        var data = new FormData();
        var request = new XMLHttpRequest();

        if(document.getElementById('name-cover').value){
            data.append('name', document.getElementById('name-cover').value);
        }
        if(document.getElementById('desc-cover').value){
            data.append('desc', document.getElementById('desc-cover').value);
        }
        if(document.getElementById('access-cover').value){
            data.append('access', document.getElementById('access-cover').value);
        }
        if(document.querySelector('#upload-cover').files[0]){
            data.append('file', document.querySelector('#upload-cover').files[0]);
        }
        request.addEventListener('load', function (e) {
            if (this.status == '200') {
                var resp = this.response
                if (resp.status == 200) {
                    alert("Updated Successfully");
                } else {
                    alert(resp.message);
                }
            } else {
                alert("FAILED!! An error Occured !");
            }
        });
        request.responseType = 'json';
        request.open('POST', "http://127.0.0.1:8000/album/"+"{{albumId}}"+"/");
        request.send(data);
    }

    // ---------------------------------------------------------------------------------------------------
    // ===== Other Functions =======

    function home() {
        window.location.href = "/photos";
    }

    function validate(type) {
        var res = {};
        if (type == 'cover') {
            res['desc'] = document.getElementById('desc-cover').value;
            res['name'] = document.getElementById('name-cover').value;
            if (!res['name']) {
                alert("Enter Name");
                return false;
            }
            res['access'] = document.getElementById('access-cover').value;
            if (!res['access']) {
                alert("Choose Access");
                return false;
            }
            if (!document.getElementById('upload-cover').files.length) {
                alert("Choose a Cover Photo");
                return false;
            }
        }
        return res;
    }
    function httpRequest(method, url, params) {
        var request = new XMLHttpRequest();
        request.open(method, url, true);
        request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        if (params == null) {
            request.send();
        } else {
            request.send(params);
        }
        return request;
    }
    function jsonToUrlParams(data) {
        url = Object.keys(data).map(function (k) {
            return encodeURIComponent(k) + '=' + encodeURIComponent(data[k])
        }).join('&')
        return url;
    }
    function imageCard(src, id, name) {
        if (name == "")
            name = "-"
        var img = document.createElement("IMG");
        img.src = src;
        img.style = "width:100%;height:100px;cursor:pointer;";
        img.onclick = function(){
            window.location.href = "http://127.0.0.1:8000/photos/"+id+"/"
        }
        var div = document.createElement("DIV");
        div.appendChild(document.createTextNode(name));

        var imgBox = document.createElement("DIV");
        imgBox.className = "image-card";
        imgBox.id = id;
        imgBox.appendChild(img);
        imgBox.appendChild(div);

        return imgBox;
    }
    function populateImages(data) {
        imgBox = document.getElementById('image-container');
        for (i = 0; i < data.length; ++i) {
            imgBox.appendChild(imageCard(data[i]['url'], data[i]['_id'], data[i]['desc']));
        }
    }
    function getMyPhotos() {
        params = {
            "userId": user._id
        };
        params = jsonToUrlParams(params)
        albumId = "{{albumId}}";
        var request = httpRequest('GET', 'http://127.0.0.1:8000/photos/album/' + albumId, true);
        request.onload = function () {
            if (this.status == '200') {
                var resp = JSON.parse(this.response);
                if (resp.status == 200) {
                    var data = resp.data;
                    populateImages(data);
                } else {
                    alert(resp.message);
                }
            } else {
                alert("Error getting photos");
            }
        };
    }

    function showAlbumForm() {
        document.getElementById('album-form').style.display = 'block';
    }
    function hideAlbumForm() {
        document.getElementById('album-form').style.display = 'none';
    }
    function deleteAlbum(id){
        if(confirm("Delete this Album?")){
            var request = httpRequest('DELETE', 'http://127.0.0.1:8000/album/' + id + "/", null);
            request.onload = function () {
            if (this.status == '200') {
                var resp = JSON.parse(this.response);
                if (resp.status == 200) {
                    alert(resp.message)
                    window.location.href = 'http://127.0.0.1:8000/users/'+user._id+'/';
                } else {
                    alert(resp.message);
                }
            } else {
                alert("Error getting photos");
            }
        };
        }
    }
    function toggleLike(el, photoId) {
        if (!el.classList.contains('liked')) {
            params = {
                "albumId": photoId,
                "userId": user._id,
                "type": "like"
            }
            params = JSON.stringify(params)
            var request = httpRequest('POST', 'http://127.0.0.1:8000/likes/album/', params);
            request.onload = function () {
                if (this.status == '200') {
                    var resp = JSON.parse(this.response);
                    if (resp.status == 200) {   
                        var data = resp.data;
                        el.classList.add('liked');
                        document.getElementById(photoId).innerHTML = parseInt(document.getElementById(photoId).innerHTML) + 1;
                    } else {
                        alert(resp.message);
                    }
                } else {
                    alert("Error getting photos");
                }
            };
        } else {
            params = {
                "albumId": photoId,
                "userId": user._id,
                "type": "unlike"
            }
            params = JSON.stringify(params)
            var request = httpRequest('POST', 'http://127.0.0.1:8000/likes/album/', params);
            request.onload = function () {
                if (this.status == '200') {
                    var resp = JSON.parse(this.response);
                    if (resp.status == 200) {
                        var data = resp.data;
                        el.classList.remove('liked');
                        document.getElementById(photoId).innerHTML = parseInt(document.getElementById(photoId).innerHTML) - 1;
                    } else {
                        alert(resp.message);
                    }
                } else {
                    alert("Error getting photos");
                }
            };
        }
    }
    function hasLiked(photoId) {
        el = document.getElementById('div_'+photoId);
        params = {
            "albumId": photoId,
            "userId": user._id
        }
        params = jsonToUrlParams(params)
        var request = httpRequest('GET', 'http://127.0.0.1:8000/likes/album?'+params, null);
        request.onload   = function () {
            if (this.status == '200') {
                var resp = JSON.parse(this.response);
                if (resp.status == 200) {
                    var data = resp.data;
                    if('_id' in data.likes){
                        if(!document.getElementById('div_'+photoId).classList.contains('liked'))
                            document.getElementById('div_'+photoId).classList.add('liked');
                    }
                } else {
                    alert(resp.message);
                }
            } else {
                alert("Error getting photos");
            }
        };
    }
</script>